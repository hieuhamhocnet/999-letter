<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>999 Bức Thư Gửi Cho Chính Mình</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Thông báo "Đã sao chép" */
        #toast {
            transition: opacity 0.3s, transform 0.3s;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Nút "Lên đầu trang" */
        #scrollTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold text-blue-600">999 Bức Thư Gửi Cho Chính Mình</h1>
            <div class="w-full max-w-md ml-4">
                <input 
                    type="text" 
                    id="searchBox" 
                    placeholder="Tìm theo số thứ tự hoặc nội dung bức thư..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Vùng hiển thị các bức thư -->
        <div id="letterGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- Các bức thư sẽ được chèn vào đây bằng JavaScript -->
        </div>

        <!-- Thông báo tải -->
        <div id="loadingMessage" class="text-center text-gray-500 mt-12">
            <p class="text-lg">Đang tải và trích xuất nội dung từ file PDF...</p>
            <p class="text-sm">(Việc này có thể mất vài giây)</p>
            <!-- Thêm một spinner đơn giản -->
            <div class="mt-4">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
            </div>
        </div>

        <!-- Thông báo không tìm thấy kết quả -->
        <div id="noResults" class="text-center text-gray-500 mt-12 hidden">
            <p class="text-lg font-medium">Không tìm thấy bức thư nào phù hợp.</p>
        </div>
    </main>

    <!-- Thông báo "Đã sao chép" (Toast) -->
    <div id="toast" class="opacity-0 transform translate-y-10 fixed bottom-10 right-10 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-xl z-50">
        Đã sao chép vào clipboard!
    </div>

    <!-- Nút "Lên đầu trang" (Scroll to Top) -->
    <button id="scrollTopBtn" class="opacity-0 transform translate-y-10 fixed bottom-10 left-10 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>

    <script>
        // --- Cấu hình và Biến toàn cục ---
        // Thiết lập workerSrc cho PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        let allLetters = []; // Mảng chứa tất cả bức thư sau khi tải
        const grid = document.getElementById('letterGrid');
        const searchBox = document.getElementById('searchBox');
        const loadingMessage = document.getElementById('loadingMessage');
        const noResults = document.getElementById('noResults');
        const toast = document.getElementById('toast');
        const scrollTopBtn = document.getElementById('scrollTopBtn');

        // --- Hàm xử lý PDF ---

        /**
         * Tải file PDF và trích xuất toàn bộ văn bản.
         * @param {string} pdfUrl - Đường dẫn đến file PDF.
         * @returns {Promise<string|null>} - Toàn bộ nội dung văn bản hoặc null nếu lỗi.
         */
        async function loadPdf(pdfUrl) {
            try {
                // Tải PDF document
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                
                let fullText = '';
                
                // Lặp qua từng trang để lấy văn bản
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // Nối các đoạn văn bản lại, giữ nguyên dấu ngắt dòng
                    const pageText = textContent.items.map(item => item.str).join('\n');
                    fullText += pageText + '\n'; // Thêm ngắt dòng giữa các trang
                }
                
                return fullText;

            } catch (error) {
                console.error("Lỗi khi tải PDF:", error);
                // Hiển thị thông báo lỗi thân thiện cho người dùng
                loadingMessage.innerHTML = `
                    <p class="text-lg text-red-600 font-bold">Lỗi! Không thể tải file PDF.</p>
                    <p class="text-gray-600">Vui lòng kiểm tra lại tên file: <strong>${pdfUrl}</strong></p>
                    <p class="text-gray-600">Và đảm bảo nó nằm cùng thư mục với file HTML khi push lên GitHub.</p>
                `;
                return null;
            }
        }

        /**
         * Hàm này rất quan trọng: Nó phân tích văn bản thô từ PDF thành các đối tượng thư.
         * @param {string} text - Văn bản thô từ PDF.
         * @returns {Array} - Mảng các đối tượng thư.
         */
        function parseTextToLetters(text) {
            const letters = [];
            // Biểu thức chính quy (regex) để tìm tiêu đề tiếng Việt.
            // Nó tìm "Bức thư... số" theo sau là các chữ số.
            const headerRegex = /Bức thư viết cho chính mình số (\d+)/g;

            // Tách toàn bộ văn bản thành các phần dựa trên tiêu đề
            // Dùng lookahead (?=...) để giữ lại tiêu đề trong kết quả tách
            const parts = text.split(/(?=Bức thư viết cho chính mình số \d+)/);

            if (parts.length <= 1) {
                console.error("Không tìm thấy mẫu thư nào trong PDF (Split failed).");
                return [];
            }

            // Bỏ qua phần tử đầu tiên (thường là nội dung rác trước thư 001)
            for (let i = 1; i < parts.length; i++) {
                const chunk = parts[i];
                
                // Trích xuất header
                const headerMatch = chunk.match(headerRegex);
                if (!headerMatch) {
                    console.warn("Bỏ qua đoạn không có header:", chunk.substring(0, 50));
                    continue;
                }
                
                const title = headerMatch[0].trim();
                
                // Trích xuất nội dung
                // Bắt đầu nội dung sau tiêu đề
                let contentStartIndex = chunk.indexOf(title) + title.length;
                
                // Tìm vị trí kết thúc của nội dung tiếng Việt.
                // Nội dung tiếng Việt luôn kết thúc trước Pinyin (Cóng jīntiān...) 
                // hoặc chữ Hán (辑二...) hoặc tiêu đề tiếp theo.