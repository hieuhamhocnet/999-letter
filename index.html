<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>999 Bức Thư Gửi Cho Chính Mình</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Thông báo "Đã sao chép" */
        #toast {
            transition: opacity 0.3s, transform 0.3s;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        #toast.hide {
            opacity: 0;
            transform: translateY(20px);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600">
                999 Bức Thư Gửi Cho Chính Mình
            </h1>
            <p class="text-gray-600 mt-2 md:mt-0">Trích xuất từ PDF</p>
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8">
        <div class="sticky top-[80px] z-5">
            <input type="text" id="searchInput" placeholder="Tìm theo số thứ tự hoặc nội dung bức thư..."
                   class="w-full p-4 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm transition-all duration-300 outline-none"
            >
        </div>
    </div>

    <main class="container mx-auto px-4 md:px-8 pb-12">
        <div id="loading-message" class="text-center text-blue-600 text-xl mt-10">
            <p>Đang tải và trích xuất nội dung từ PDF...</p>
            <p classs="text-sm text-gray-500">(File: 999-thu.pdf)</p>
        </div>
        <div id="letter-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            </div>
        <p id="no-results" class="text-center text-gray-500 text-xl hidden mt-10">
            Không tìm thấy bức thư nào phù hợp.
        </p>
    </main>

    <div id="toast"
         class="fixed bottom-10 right-10 bg-green-600 text-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-5 hide">
        Đã sao chép nội dung!
    </div>

    <button id="scrollTopBtn" title="Lên đầu trang"
            class="fixed bottom-10 right-10 p-3 rounded-full bg-blue-500 text-white shadow-lg hover:bg-blue-600 transition-opacity duration-300 opacity-0 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
    </button>


    <script>
        // Mảng toàn cục để lưu trữ các bức thư sau khi trích xuất
        let allLetters = [];

        const grid = document.getElementById('letter-grid');
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('no-results');
        const toast = document.getElementById('toast');
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const loadingMessage = document.getElementById('loading-message');
        let toastTimer;

        // Chỉ định workerSrc cho PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // --- Hàm tải và trích xuất PDF ---
        async function loadPdf(url) {
            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // SỬA LỖI QUAN TRỌNG: Nối bằng \n (ngắt dòng) để giữ cấu trúc
                    const pageText = textContent.items.map(item => item.str).join('\n');
                    fullText += pageText + '\n\n'; // Thêm ngắt trang
                }
                
                return fullText;
            } catch (error) {
                console.error('Lỗi khi tải PDF:', error);
                loadingMessage.innerText = 'Lỗi! Không thể tải file PDF. Vui lòng kiểm tra tên file và đảm bảo nó nằm cùng thư mục với file HTML.';
                loadingMessage.classList.add('text-red-600');
                loadingMessage.classList.remove('text-blue-600');
                return null;
            }
        }

        // --- HÀM PHÂN TÍCH VĂN BẢN (ĐÃ VIẾT LẠI) ---
        function parseTextToLetters(rawText) {
            const letters = [];
            // Regex để "cắt" văn bản thành các phần, bắt đầu bằng "Bức thư viết cho chính mình số..."
            // Nó linh hoạt với khoảng trắng (\s+) và các biến thể dấu
            const splitRegex = /B[ứu]c\s+th[ưu]\s+vi[ếe]t\s+cho\s+ch[íi]nh\s+m[ìi]nh\s+s[ốo]\s*(\d{1,3})/gi;

            // Tách toàn bộ văn bản dựa trên tiêu đề tiếng Việt
            const parts = rawText.split(splitRegex);

            if (parts.length <= 1) {
                console.error('Không tìm thấy mẫu thư nào trong PDF (Split failed).');
                loadingMessage.innerText = 'Đã tải PDF nhưng không tìm thấy mẫu thư nào. (Lỗi logic 1)';
                loadingMessage.classList.remove('hidden');
                loadingMessage.classList.add('text-red-600');
                loadingMessage.classList.remove('text-blue-600');
                return [];
            }

            // `parts` bây giờ sẽ là:
            // [0] = "Mục lục, Lời nói đầu..."
            // [1] = "001" (ID từ nhóm 1)
            // [2] = "Kể từ hôm nay... Rénshēng..." (Nội dung 1)
            // [3] = "002" (ID từ nhóm 2)
            // [4] = "Đời người luôn có... Suowèi..." (Nội dung 2)
            // ...

            let contentIndex = 2; // Bắt đầu từ phần tử nội dung đầu tiên
            for (let i = 1; i < parts.length; i += 2) { // Lặp qua các ID (1, 3, 5...)
                if (parts.length <= contentIndex) break; // Dừng nếu không đủ phần tử

                const id = parseInt(parts[i]);
                let contentBlock = parts[contentIndex];

                // Tìm điểm kết thúc nội dung tiếng Việt (nơi Pinyin hoặc Hán tự bắt đầu)
                // [\u4e00-\u9fa5] -> Ký tự Hán
                // [A-Z][a-zāáăà...]{2,} -> Pinyin (thường bắt đầu bằng chữ hoa)
                const endMatch = contentBlock.match(/([A-Z][a-zāáăàēéĕèīíĭìōóŏòūúŭùüǖǘǚǜêÇñ]{2,}|[\u4e00-\u9fa5])/);
                
                let vietContent = contentBlock;
                if (endMatch) {
                    vietContent = contentBlock.substring(0, endMatch.index);
                }
                
                // Dọn dẹp
                vietContent = vietContent.trim();
                vietContent = vietContent.replace(/\s\d+\s*$/, '').trim(); // Xóa số trang ở cuối

                if (vietContent.length > 20) { // Đảm bảo là nội dung thật
                    letters.push({ id: id, content: vietContent });
                }

                contentIndex += 2; // Chuyển đến khối nội dung tiếp theo
            }
            
            if (letters.length === 0) {
                 // Lỗi 224 của bạn sẽ xảy ra ở đây nếu logic tìm Pinyin/Hán Tự thất bại
                 console.error('Đã tìm thấy header nhưng không trích xuất được nội dung.');
                 loadingMessage.innerText = 'Đã tải PDF nhưng không phân tích được nội dung. (Lỗi logic 4)';
                 loadingMessage.classList.remove('hidden');
                 loadingMessage.classList.add('text-red-600');
                 loadingMessage.classList.remove('text-blue-600');
            }
            
            return letters;
        }

        // --- Hàm hiển thị thông báo "Đã sao chép" ---
        function showToast() {
            if (toastTimer) clearTimeout(toastTimer);
            toast.classList.add('show');
            toast.classList.remove('hide');

            toastTimer = setTimeout(() => {
                toast.classList.add('hide');
                toast.classList.remove('show');
            }, 2000);
        }

        // --- Hàm sao chép nội dung ---
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast(); 
            } catch (err) {
                console.error('Không thể sao chép:', err);
            }

            document.body.removeChild(textarea);
        }

        // --- Hàm hiển thị danh sách các bức thư ---
        function renderLetters(letters) {
            grid.innerHTML = ''; // Xóa nội dung cũ
            
            if (letters.length === 0) {
                // Chỉ hiển thị 'Không tìm thấy' nếu không có lỗi tải
                if (!loadingMessage.classList.contains('text-red-600')) {
                    noResults.classList.remove('hidden');
                }
            } else {
                noResults.classList.add('hidden');
            }

            letters.forEach(letter => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col';
                
                // SỬA LỖI QUAN TRỌNG: Chuyển \n (ngắt dòng) thành <br> để hiển thị
                const formattedContent = letter.content.replace(/\n/g, '<br>');

                const letterContent = `
                    <h2 class="text-xl font-semibold text-blue-700 mb-3">
                        Bức thư số ${letter.id.toString().padStart(3, '0')}
                    </h2>
                    <p class="text-gray-700 leading-relaxed mb-4 flex-grow">
                        ${formattedContent}
                    </p>
                    <button class="copy-btn mt-auto bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-300 self-start" 
                            data-id="${letter.id}">
                        Sao chép nội dung
                    </button>
                `;
                
                card.innerHTML = letterContent;
                grid.appendChild(card);
            });
        }

        // --- Xử lý sự kiện tìm kiếm ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            const filteredLetters = allLetters.filter(letter => {
                const letterIdMatch = letter.id.toString().padStart(3, '0').includes(searchTerm);
                const contentMatch = letter.content.toLowerCase().includes(searchTerm);
                return letterIdMatch || contentMatch;
            });
            
            renderLetters(filteredLetters);
        });

        // --- Xử lý sự kiện nhấp chuột (để sao chép) ---
        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('copy-btn')) {
                const letterId = parseInt(e.target.getAttribute('data-id'));
                const letterToCopy = allLetters.find(l => l.id === letterId);
                
                if (letterToCopy) {
                    // Khi sao chép, giữ lại \n thay vì <br>
                    const textToCopy = `Bức thư số ${letterToCopy.id.toString().padStart(3, '0')}\n\n${letterToCopy.content}`;
                    copyToClipboard(textToCopy);
                }
            }
        });

        // --- Xử lý nút Lên đầu trang ---
        window.onscroll = () => {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollTopBtn.classList.remove('hidden');
                scrollTopBtn.classList.add('opacity-100');
            } else {
                scrollTopBtn.classList.add('hidden');
                scrollTopBtn.classList.remove('opacity-100');
            }
        };

        scrollTopBtn.onclick = () => {
            document.body.scrollTop = 0; 
            document.documentElement.scrollTop = 0;
        };

        // --- Tải và xử lý PDF khi trang được tải ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            const fileName = '999-thu.pdf'; 
            let pdfUrl = fileName; 
            
            try {
                pdfUrl = encodeURI(fileName);
            } catch(e) {
                console.warn("Không thể mã hóa URL PDF", e);
                pdfUrl = fileName; // Dùng tên gốc nếu lỗi
            }
            
            const rawText = await loadPdf(pdfUrl);
            
            if (rawText) {
                allLetters = parseTextToLetters(rawText);
                
                // Ẩn thông báo tải và hiển thị lưới
                loadingMessage.classList.add('hidden');
                grid.classList.remove('hidden');
                
                renderLetters(allLetters);
            }
        });
    </script>

</body>
</html>